function classic(){var w=[p("w","k",8,5),p("w","q",8,4),p("w","b",8,3),p("w","b",8,6),p("w","n",8,2),p("w","n",8,7),p("w","r",8,1),p("w","r",8,8),p("b","k",1,5),p("b","q",1,4),p("b","b",1,3),p("b","b",1,6),p("b","n",1,2),p("b","n",1,7),p("b","r",1,1),p("b","r",1,8)];for(let b=1;b<=8;b++)w.push(p("w","p",7,b)),w.push(p("b","p",2,b));return w}function tenXten(){var w=[p("w","k",10,6),p("w","q",10,4),p("w","q",10,7),p("w","b",10,3),p("w","b",10,8),p("w","n",10,2),p("w","n",10,9),p("w","r",10,1),p("w","r",10,10),p("w","x",10,5),p("b","k",1,6),p("b","q",1,4),p("b","q",1,7),p("b","b",1,3),p("b","b",1,8),p("b","n",1,2),p("b","n",1,9),p("b","r",1,1),p("b","r",1,10),p("b","x",1,5)];for(let b=1;b<=10;b++)w.push(p("w","p",9,b)),w.push(p("b","p",2,b));return w}
function createBoard(t){const e=document.querySelector("table"),a=Array(t).fill(1).map((t,e)=>t+e);a.forEach(c=>{const d=document.createElement("tr");e.append(d),a.forEach(t=>{var e=document.createElement("td"),t=(e.setAttribute("id",c.toString()+t.toString()),e.classList.add((c+t)%2?"blackBoard":"whiteBoard"),document.createElement("div")),a=(t.setAttribute("class","text"),document.createElement("div"));a.classList.add("touch","hideEle"),a.textContent="O",d.append(e),e.append(t,a)})})}
async function setCustomizableChess(){let r,n,o=[];function e(e,i){return()=>{changeColorOf(r="kqrnbxp".indexOf(e),i)}}function t(e,t,i){return()=>{0<n[r]&&getPieceWhoseLocationIs(i.vert,i.hori,o).piece===Piece.null&&(e.textContent=["킹","퀸","룩","말","비숍","","폰"][r],o.push(new PieceStruct(t,r,i)),n[r]+=-1,e.style.color=t?"black":"lightgray",Array.from("kqrnbxp").forEach((e,i)=>{"x"!==e&&(t?q("#blackSide ."+e).textContent=["킹","퀸","룩","말","비숍","","폰"][i]+"x"+n[i]:q("#whiteSide ."+e).textContent=["킹","퀸","룩","말","비숍","","폰"][i]+"x"+n[i])}))}}r=Piece.Pawn,n=[1,1,2,2,2,0,8],blackSide.style.visibility="hidden",whiteSide.style.visibility="visible",changeColorOf(r,Side.White);for(var i of"kqrnbp")q("#whiteSide ."+i).addEventListener("click",e(i,Side.White));for(let i=5;i<=8;i++)for(let e=1;e<=8;e++)qid(""+i+e).addEventListener("click",t(qid(""+i+e),Side.White,{vert:i,hori:e}));await waitUntil(()=>n.every(e=>0===e));for(var l of"kqrnbp")q("#whiteSide ."+l).removeEventListener("click",e(l,Side.White));for(let i=5;i<=8;i++)for(let e=1;e<=8;e++)qid(""+i+e).removeEventListener("click",t(qid(""+i+e),Side.White,{vert:i,hori:e}));r=Piece.Pawn,n=[1,1,2,2,2,0,8],blackSide.style.visibility="visible",whiteSide.style.visibility="hidden",changeColorOf(r,Side.Black);for(var c of"kqrnbp")q("#blackSide ."+c).addEventListener("click",e(c,Side.Black));for(let i=1;i<=4;i++)for(let e=1;e<=8;e++)qid(""+i+e).addEventListener("click",t(qid(""+i+e),Side.Black,{vert:i,hori:e}));await waitUntil(()=>n.every(e=>0===e));for(var d of"kqrnbp")q("#blackSide ."+d).removeEventListener("click",e(d,Side.Black));for(let i=1;i<=4;i++)for(let e=1;e<=8;e++)qid(""+i+e).removeEventListener("click",t(qid(""+i+e),Side.Black,{vert:i,hori:e}));return o}function q(e){return document.querySelector(e)}function qid(e){return document.getElementById(e)}function changeColorOf(e,i){for(var t of"kqrnbp")q(`#${i?"black":"white"}Side .`+t).style.backgroundColor="gray";q(`#${i?"black":"white"}Side .`+"kqrnbxp"[e]).style.setProperty("background-color",i?"white":"black","important")}
const body=document.querySelector("body"),o=document.querySelector("#o"),x=document.querySelector("#x"),whiteSide=document.querySelector("#whiteSide"),blackSide=document.querySelector("#blackSide"),blackEaten=document.querySelector("#whiteSide .eaten"),whiteEaten=document.querySelector("#blackSide .eaten"),shower=document.querySelector("#shower"),wTimer=document.querySelector("#whiteSide .timer"),bTimer=document.querySelector("#blackSide .timer"),promotionGrid=document.querySelector("#promotionGrid"),special=document.querySelector("#special"),board=document.querySelector("#board"),gameInfos=document.querySelectorAll(".gameInfo"),customs=document.querySelectorAll(".custom");body,o,x,whiteSide,blackSide,whiteEaten,blackEaten,shower,wTimer,bTimer,promotionGrid,special,board,gameInfos,customs;
function eatenPieces(t){whiteEaten.textContent="먹은거: "+(t.white.length?t.white.sort((t,e)=>t-e).map(t=>-2===t?"백마탄 여왕님":-1===t?"흑마탄 여왕님":["왕","여왕","비숍","말","룩","폰"][t]).join(", "):"없음"),blackEaten.textContent="먹은거: "+(t.black.length?t.black.sort((t,e)=>t-e).map(t=>-2===t?"백마탄 여왕님":-1===t?"흑마탄 여왕님":["왕","여왕","비숍","말","룩","폰"][t]).join(", "):"없음")}
function applyFullscreen(){var e=document.querySelector("#full");const t=document.querySelector("#fullscreen");e?.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen&&(t?.setAttribute("src","../../imgs/fullscreen.png"),document.exitFullscreen()):(t?.setAttribute("src","../../imgs/exit-fullscreen.png"),document.documentElement.requestFullscreen())})}
class Game{board=[];boardsize=8;mode=Mode.null;movableLocations=[];presentLocation={vert:-1,hori:-1};turn=Side.White;eatens={white:[],black:[]};showdelay=2e3;moves=0;constructor({boardsize:e,customBoard:i=[]}){i.length?this.board=i:this.board=(10===e?tenXten:classic)(),this.boardsize=e,createBoard(this.boardsize)}showPieces(e=[]){showPiecesFN(this.board,this.boardsize,e)}async willMoveListener(t){let i={vert:-1,hori:-1},r=!1;function e(e){return()=>{i=e}}function o(e){return()=>{i=e,r=!0}}this.board.forEach(e=>{var i;e.side===t&&((i=document.getElementById(byString(e.location)))?.classList.add(["choosableWhite","choosableBlack"][Array.from(i.id).map(e=>parseInt(e)).reduce((e,i)=>e+i,0)%2]),i?.addEventListener("click",o(e.location)))});for(var s of this.movableLocations){var h=document.getElementById(byString(s));h?.classList.add(["choosableWhite","choosableBlack"][Array.from(h.id).map(e=>parseInt(e)).reduce((e,i)=>e+i,0)%2]),h?.addEventListener("click",e(s))}await waitUntil(()=>-1!==i.hori),this.board.forEach(e=>{var i=document.getElementById(byString(e.location));i?.classList.remove("choosableBlack","choosableWhite"),i?.removeEventListener("click",o(e.location))});for(var a of this.movableLocations){var n=document.getElementById(byString(a));n?.classList.remove("choosableBlack","choosableWhite"),n?.removeEventListener("click",e(a))}return{chosenLocation:i,choosingAction:r}}init(){initBoard(this.boardsize),this.movableLocations=[],this.presentLocation={vert:-1,hori:-1}}showScreen(){this.showPieces(),eatenPieces(this.eatens)}showPresentTurn(){switch(this.turn){case Side.White:whiteSide?.classList.remove("opacityDown"),blackSide?.classList.add("opacityDown");break;case Side.Black:blackSide?.classList.remove("opacityDown"),whiteSide?.classList.add("opacityDown")}}movableLocationsOf(e,i){const t=this.board[e];let r=Object.values(ml)[t.piece],o=(r=-1!==r.name.indexOf("Pawn")?t.side===Side.White?ml.wPawn:ml.bPawn:r)(t,this.board,this.boardsize);if(i){const d=JSON.stringify(this.board);o=o.filter(e=>(this.board=JSON.parse(d),this.board=this.board.map(e=>{var i=new PieceStruct(e.side,e.piece,e.location);return i.haveMoved=e.haveMoved,i.twoTimesRightBefore=e.twoTimesRightBefore,i}),this.moveTo(t.location,e,{show:!1,notation:new Notation}),!this.ifMySideChecked(this.turn))),this.board=JSON.parse(d),this.board=this.board.map(e=>{var i=new PieceStruct(e.side,e.piece,e.location);return i.haveMoved=e.haveMoved,i.twoTimesRightBefore=e.twoTimesRightBefore,i})}if(t.piece===Piece.King&&!1===t.haveMoved){{var s=t.vert;let e=t.hori;var h=[];for(e=t.hori+1;e<=this.boardsize-1;e++){var a=this.ifMySideChecked(this.turn,new PieceStruct(this.turn,t.piece,{vert:s,hori:e}));h.push(a)}(h.some(e=>!0===e)||this.ifMySideChecked(this.turn))&&-1!==o.indexOf({vert:t.vert,hori:t.hori+2})&&(o=o.filter(e=>byString(e)!==byString({vert:t.vert,hori:t.hori+2})))}{var n=t.vert;let e=t.hori;var c=[];for(e=t.hori-1;e<=2;e--){var l=this.ifMySideChecked(this.turn,new PieceStruct(this.turn,t.piece,{vert:n,hori:e}));c.push(l)}(c.some(e=>!0===e)||this.ifMySideChecked(this.turn))&&-1!==o.indexOf({vert:t.vert,hori:t.hori-2})&&(o=o.filter(e=>byString(e)!==byString({vert:t.vert,hori:t.hori-2})))}}return o??[]}showWillMoveLocatoin(e){var e=this.getIndexWhoseLocationIs(e),i=this.board[e];this.movableLocations=this.movableLocationsOf(e,!0),initBoard(this.boardsize),this.presentLocation===i.location?(this.showPieces(),this.presentLocation={vert:-1,hori:-1}):(this.showPieces(this.movableLocations),this.presentLocation=i.location)}showCheckMSG(){shower.innerHTML="체!크!",shower.style.color="yellow",shower.style.display="flex",this.turn===Side.Black&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),setTimeout(()=>{shower.style.display="none",shower.style.transform="translate(-50%, -50%) rotate(0deg)"},this.showdelay)}changeTurn(e){e.stop(this.turn),this.turn=this.turn===Side.White?Side.Black:Side.White,e.start(this.turn)}twoTimesRightBeforeFalse(){for(var e of this.board)e.side===this.turn&&e.piece===Piece.Pawn&&(e.twoTimesRightBefore=!1)}getIndexWhoseLocationIs(t){let r=-1;return this.board.forEach((e,i)=>{byString(e.location)===byString(t)&&(r=i)}),r}ifMySideChecked(i,e=new PieceStruct(Side.null,Piece.null,{vert:-1,hori:-1})){let t=this.board.filter(e=>e.piece===Piece.King&&e.side===i)[0];if(e.side!==Side.null&&(t=e),ml.rook(t,this.board,this.boardsize,!1).filter(e=>{const i=this.getPieceWhoseLocationIs(e);return[Piece.Queen,Piece.Rook,Piece.NighQueen].some(e=>i.piece===e)}).length)return!0;if(ml.bishop(t,this.board,this.boardsize,!1).filter(e=>{const i=this.getPieceWhoseLocationIs(e);return[Piece.Bishop,Piece.Queen,Piece.NighQueen].some(e=>i.piece===e)}).length)return!0;if(ml.night(t,this.board,this.boardsize,!1).filter(e=>{const i=this.getPieceWhoseLocationIs(e);return[Piece.Night,Piece.NighQueen].some(e=>i.piece===e)}).length)return!0;let r=[];return i===Side.White&&(r=[{vert:t.vert-1,hori:t.hori+1},{vert:t.vert-1,hori:t.hori-1}]),(r=(r=i===Side.Black?[{vert:t.vert+1,hori:t.hori+1},{vert:t.vert+1,hori:t.hori-1}]:r).filter(e=>Object.values(e).every(e=>1<=e&&e<=this.boardsize)).filter(e=>{e=this.getPieceWhoseLocationIs(e);return e.piece!==Piece.null&&e.side!==i})).filter(e=>{const i=this.getPieceWhoseLocationIs(e);return[Piece.Pawn].some(e=>i.piece===e)}),!!r.length||!!ml.king(t,this.board,this.boardsize,!1).filter(e=>{const i=this.getPieceWhoseLocationIs(e);return[Piece.King].some(e=>i.piece===e)}).length}getKingOfOppo(e){for(var i of this.board)if(i.side===(e===Side.White?Side.Black:Side.White)&&i.piece===Piece.King)return i;return new PieceStruct(Side.null,Piece.null,{vert:-1,hori:-1})}async moveTo(e,i,{show:t,notation:r}){var o=this.getIndexWhoseLocationIs(i);const s=this.board[this.getIndexWhoseLocationIs(e)];let h=!1,a=!1,n="",c=!1;e=s.piece;-1!==o&&this.board[o].side!==this.turn&&(a=!0,t&&this.eatens[this.turn?"white":"black"].push(this.board[o].piece===Piece.NighQueen?this.board[o].side===Side.White?-2:-1:this.board[o].piece===Piece.Pawn?5:this.board[o].piece),this.board=[...this.board.slice(0,o),...this.board.slice(o+1,this.board.length)],t)&&(h=!0),-1===o&&s.piece===Piece.Pawn&&i.hori-s.hori&&(a=!0,o=this.getIndexWhoseLocationIs({vert:i.vert-(2*s.side-1),hori:i.hori}),this.board=[...this.board.slice(0,o),...this.board.slice(o+1,this.board.length)],t&&this.eatens[this.turn?"white":"black"].push(),t)&&(shower.innerHTML="앙파상!",shower.style.display="flex",this.turn===Side.Black&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),setTimeout(()=>{shower.style.display="none",shower.style.transform="translate(-50%, -50%) rotate(0deg)"},this.showdelay)),s.piece===Piece.Pawn&&(s.haveMoved||2!==Math.abs(s.location.vert-i.vert)||(s.twoTimesRightBefore=!0),s.haveMoved=!0,t)&&(h=!0);let l="킹";if(s.piece===Piece.King&&!1===s.haveMoved&&(i.hori-s.hori==2&&(n="0-0",this.board[this.getIndexWhoseLocationIs({vert:s.vert,hori:this.boardsize})].location={vert:s.vert,hori:s.hori+1}),i.hori-s.hori==-2&&(l="퀸",n="0-0-0",this.board[this.getIndexWhoseLocationIs({vert:s.vert,hori:1})].location={vert:s.vert,hori:s.hori-1}),2===Math.abs(i.hori-s.hori))&&t&&(shower.innerHTML=l+"사이드<br>캐슬링!",shower.style.display="flex",this.turn===Side.Black&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),setTimeout(()=>{shower.style.display="none",shower.style.transform="translate(-50%, -50%) rotate(0deg)"},this.showdelay)),[Piece.King,Piece.Rook].some(e=>s.piece===e)&&(s.haveMoved=!0),s.location=i,t&&(h?this.moves=0:this.moves+=1),i.vert===(s.side?this.boardsize:1)&&s.piece===Piece.Pawn&&t){c=!0;o=await promotion(this.mode);let e=Piece.null;switch(o){case"퀸":e=Piece.Queen;break;case"비숍":e=Piece.Bishop;break;case"나이트":e=Piece.Night;break;case"룩":e=Piece.Rook;break;case"나이트퀸":e=Piece.NighQueen}s.piece=e}t&&r.add(e,s.location,a,c,this.ifMySideChecked(this.turn?Side.White:Side.Black),n)}getPieceWhoseLocationIs(t){let r=-1;return this.board.forEach((e,i)=>{byString(e.location)===byString(t)&&(r=i)}),-1===r?new PieceStruct(Side.null,Piece.null,{vert:0,hori:0}):this.board[r]}impossibilityOfCheckMate(){var e=this.board.filter(e=>e.side===Side.White),i=this.board.filter(e=>e.side===Side.Black);if(1===e.length&&1===i.length)return!0;if(1===e.length&&i.filter(e=>e.piece===Piece.Bishop).length===i.length-1&&i.filter(e=>e.piece===Piece.Bishop).map(e=>(e.vert+e.hori)%2).every((e,i,t)=>e===t[0]))return!0;if(1===i.length&&e.filter(e=>e.piece===Piece.Bishop).length===e.length-1&&e.filter(e=>e.piece===Piece.Bishop).map(e=>(e.vert+e.hori)%2).every((e,i,t)=>e===t[0]))return!0;if(1===e.length&&2===i.length&&1===i.filter(e=>e.piece===Piece.Night).length)return!0;if(1===i.length&&2===e.length&&1===e.filter(e=>e.piece===Piece.Night).length)return!0;if(e.filter(e=>e.piece===Piece.Bishop).length===e.length-1&&i.filter(e=>e.piece===Piece.Bishop).length===i.length-1&&e.filter(e=>e.piece===Piece.Bishop).map(e=>(e.vert+e.hori)%2).every((e,i,t)=>e===t[0])&&i.filter(e=>e.piece===Piece.Bishop).map(e=>(e.vert+e.hori)%2).every((e,i,t)=>e===t[0])){e=e.filter(e=>e.piece===Piece.Bishop)[0],e=(e.vert+e.hori)%2,i=i.filter(e=>e.piece===Piece.Bishop)[0];if(e==(i.vert+i.hori)%2)return!0}return!1}trifoldRep(e){var i=e.notation,t=i.shift();let r=!1;for(let e=2;e<i.length;e+=2){var o=Game.tieArray(i,e);if(2<=o.length&&o[0]===o[1]&&t&&0===Game.reverseStr(o[0]).indexOf(Game.reverseStr(t))){r=!0;break}}return void 0!==t&&i.unshift(t),r}static tieArray(i,t){var r=[];for(let e=0;e<i.length;e+=t)r.push(i.slice(e,e+t).join(""));return r}static reverseStr(e){return e.split("").reverse().join()}}
function getPieceWhoseLocationIs(e,r,i){const o={vert:e,hori:r};let t=-1;return i.forEach((e,r)=>{byString(e.location)===byString(o)&&(t=r)}),-1===t?new PieceStruct(Side.null,Piece.null,{vert:0,hori:0}):i[t]}function king(r,i,o,t=!0){var e=[{vert:r.vert+1,hori:r.hori+1},{vert:r.vert+1,hori:r.hori-1},{vert:r.vert-1,hori:r.hori+1},{vert:r.vert-1,hori:r.hori-1},{vert:r.vert+1,hori:r.hori},{vert:r.vert-1,hori:r.hori},{vert:r.vert,hori:r.hori+1},{vert:r.vert,hori:r.hori-1}].filter(e=>Object.values(e).every(e=>1<=e&&e<=o)).filter(e=>{e=getPieceWhoseLocationIs(e.vert,e.hori,i);return!(e.side===Side.null&&!t)&&e.side!==r.side});return!1===r.haveMoved&&(Array(o/2-2).fill(0).map((e,r)=>r+1).every(e=>-1===getPieceWhoseLocationIs(r.vert,r.hori+e,i).piece)&&!1===getPieceWhoseLocationIs(r.vert,o,i).haveMoved&&e.push({vert:r.vert,hori:r.hori+2}),Array(o/2-1).fill(0).map((e,r)=>r+1).every(e=>-1===getPieceWhoseLocationIs(r.vert,r.hori-e,i).piece))&&!1===getPieceWhoseLocationIs(r.vert,1,i).haveMoved&&e.push({vert:r.vert,hori:r.hori-2}),e}function queen(e,r,i,o=!0){return[...bishop(e,r,i,o),...rook(e,r,i,o)]}function bishop(o,t,h,v=!0){let s=[];function i(e,r){var i;return[e,r].some(e=>e<=0||h<e)||((i=getPieceWhoseLocationIs(e,r,t)).piece!==Piece.null?(i.side===o.side||s.push({vert:e,hori:r}),1):void(v&&s.push({vert:e,hori:r})))}for(let[e,r]=[o.vert,o.hori];e++,r++,!i(e,r););for(let[e,r]=[o.vert,o.hori];e++,r--,!i(e,r););for(let[e,r]=[o.vert,o.hori];e--,r++,!i(e,r););for(let[e,r]=[o.vert,o.hori];e--,r--,!i(e,r););return s=s.filter(e=>{return getPieceWhoseLocationIs(e.vert,e.hori,t).side!==o.side})}function night(r,i,o,t=!0){return[{vert:r.vert+2,hori:r.hori+1},{vert:r.vert+2,hori:r.hori-1},{vert:r.vert-2,hori:r.hori+1},{vert:r.vert-2,hori:r.hori-1},{vert:r.vert+1,hori:r.hori+2},{vert:r.vert-1,hori:r.hori+2},{vert:r.vert+1,hori:r.hori-2},{vert:r.vert-1,hori:r.hori-2}].filter(e=>Object.values(e).every(e=>1<=e&&e<=o)).filter(e=>{e=getPieceWhoseLocationIs(e.vert,e.hori,i);return!(e.side===Side.null&&!t)&&e.side!==r.side})}function rook(o,t,r,h=!0){const v=[];function i(e,r){var i=getPieceWhoseLocationIs(e,r,t);if(i.side!==Side.null)return i.side!==o.side&&v.push({vert:e,hori:r}),1;h&&v.push({vert:e,hori:r})}for(let e=o.vert+1;e<=r&&!i(e,o.hori);e++);for(let e=o.vert-1;1<=e&&!i(e,o.hori);e--);for(let e=o.hori+1;e<=r&&!i(o.vert,e);e++);for(let e=o.hori-1;1<=e&&!i(o.vert,e);e--);return v}function wPawn(r,i,e){var o=[],t=r.haveMoved?1:2;for(let e=r.vert-1;1<=e&&e>=r.vert-t;e--){const h=getPieceWhoseLocationIs(e,r.hori,i);if(h.piece!==Piece.null)break;o.push({vert:e,hori:r.hori})}var h=getPieceWhoseLocationIs(r.vert-1,r.hori+1,i),h=(h.side!==r.side&&h.side!==Side.null&&o.push({vert:r.vert-1,hori:r.hori+1}),getPieceWhoseLocationIs(r.vert-1,r.hori-1,i));return h.side!==r.side&&h.side!==Side.null&&o.push({vert:r.vert-1,hori:r.hori-1}),4===r.vert&&8===e&&((h=getPieceWhoseLocationIs(r.vert,r.hori-1,i)).side!==r.side&&h.piece===Piece.Pawn&&h.twoTimesRightBefore&&o.push({vert:r.vert-1,hori:r.hori-1}),(h=getPieceWhoseLocationIs(r.vert,r.hori+1,i)).side!==r.side)&&h.piece===Piece.Pawn&&h.twoTimesRightBefore&&o.push({vert:r.vert-1,hori:r.hori+1}),o}function bPawn(r,i,o){var t=[],h=r.haveMoved?1:2;for(let e=r.vert+1;e<=o&&e<=r.vert+h;e++){const v=getPieceWhoseLocationIs(e,r.hori,i);if(v.piece!==Piece.null)break;t.push({vert:e,hori:r.hori})}var v=getPieceWhoseLocationIs(r.vert+1,r.hori+1,i),v=(v.side!==r.side&&v.side!==Side.null&&t.push({vert:r.vert+1,hori:r.hori+1}),getPieceWhoseLocationIs(r.vert+1,r.hori-1,i));return v.side!==r.side&&v.side!==Side.null&&t.push({vert:r.vert+1,hori:r.hori-1}),5===r.vert&&8===o&&((v=getPieceWhoseLocationIs(r.vert,r.hori-1,i)).side!==r.side&&v.piece===Piece.Pawn&&v.twoTimesRightBefore&&t.push({vert:r.vert+1,hori:r.hori-1}),(v=getPieceWhoseLocationIs(r.vert,r.hori+1,i)).side!==r.side)&&v.piece===Piece.Pawn&&v.twoTimesRightBefore&&t.push({vert:r.vert+1,hori:r.hori+1}),t}function nighQueen(e,r,i,o=!0){let t=[...bishop(e,r,i,o),...rook(e,r,i,o),...night(e,r,i,o)];return t=t.filter((e,r)=>t.indexOf(e)===r)}const ml={king:king,queen:queen,bishop:bishop,night:night,rook:rook,nighQueen:nighQueen,wPawn:wPawn,bPawn:bPawn};
class Notation{notation=[];add(t,i,a,n,o,h){var t="KQBNRXP"[t],a=a?"x":"",s="abcdefghij"[i.vert],i="abcdefghij"[i.hori],n=n?"=":"",o=o?"+":"";""!==h?this.notation.unshift(h):this.notation.unshift(t+a+s+i+n+o)}}
class PieceStruct{side;piece;location;haveMoved=null;twoTimesRightBefore=null;constructor(e,i,t){this.side=e,this.piece=i,this.location=t,this.piece===Piece.Pawn&&(this.haveMoved=!1,this.twoTimesRightBefore=!1),[Piece.King,Piece.Rook].some(e=>e===this.piece)&&(this.haveMoved=!1)}get vert(){return this.location.vert}get hori(){return this.location.hori}}
function p(e,r,n,t){return new PieceStruct(parseInt(Object.keys(Side)[Array.from("wb").indexOf(e)]),parseInt(Object.keys(Piece)[Array.from("kqbnrxp").indexOf(r)]),{vert:n,hori:t})}
const promotionWindow=document.querySelector("#promotionWindow"),options=document.querySelectorAll("#promotionGrid div");async function promotion(o){let i="";function t(o){return()=>{i=o,console.log("hello")}}return promotionWindow.style.visibility="visible",o===Mode.tenXten&&(document.querySelector("#promotionGrid #special").style.visibility="visible"),options.forEach(o=>{o.addEventListener("click",t(o.textContent))}),await waitUntil(()=>""!==i),options.forEach(o=>{o.removeEventListener("click",t(o.textContent))}),promotionWindow.style.visibility="hidden",o===Mode.tenXten&&(document.querySelector("#promotionGrid #special").style.visibility="hidden"),i}
function showPiecesFN(e,t,i=[]){for(var o of e){var s=document.getElementById(byString(o.location))?.querySelector(".text");s.classList.remove("whitePiece","blackPiece"),s.classList.remove("whiteNighQueen","blackNighQueen"),s.style.backgroundSize="0 0",s.classList.add(["whitePiece","blackPiece"][o.side]),o.piece===Piece.NighQueen?(o.side===Side.White?s.classList.add("whiteNighQueen"):s.classList.add("blackNighQueen"),s.style.backgroundSize="100% 100%"):(o.piece===Piece.Pawn?s.style.backgroundPosition=`100% ${100*o.side}%`:s.style.backgroundPosition=`${20*o.piece}% ${100*o.side}%`,s.style.backgroundSize="600% 200%")}for(let e=11;e<=10*t+1;e+=10)(document.getElementById(e.toString())?.querySelector(".text")).innerHTML||="&nbsp;";for(var c of i){c=document.getElementById(byString(c))?.querySelector(".touch");c?.classList.remove("hideEle","showEle"),c?.classList.add("showEle")}}function initBoard(i){for(let t=1;t<=i;t++)for(let e=1;e<=i;e++){var o=document.getElementById(byString({vert:t,hori:e}))?.querySelector(".touch");o?.classList.remove("hideEle","showEle"),o?.classList.add("hideEle"),(document.getElementById(byString({vert:t,hori:e}))?.querySelector(".text")).style.backgroundSize="0 0"}}
"use strict";class Sound{pieceSet=new Audio("../../sound/pieceSet.mp3");checkmate=new Audio("../../sound/checkmate.m4a");check=new Audio("../../sound/check.m4a");fiftyMoves=new Audio("../../sound/fiftyMoves.m4a");impossibilityOfCheckmate=new Audio("../../sound/impossibilityOfCheckmate.m4a");stalemate=new Audio("../../sound/stalemate.m4a");trifoldRepitition=new Audio("../../sound/trifoldRepitition.m4a")}
class Timer{white;black;wTimer;bTimer;plus;originalSecond;constructor({second:t,plus:i}){this.white=this.black=this.originalSecond=t,this.plus=i}start(t){t===Side.White?this.wTimer=setInterval(()=>{this.white--},1e3):this.bTimer=setInterval(()=>{this.black--},1e3)}stop(t){t===Side.White?(clearInterval(this.wTimer),this.white+this.plus<=this.originalSecond?this.white+=this.plus:this.white=this.originalSecond):(clearInterval(this.bTimer),this.black+this.plus<=this.originalSecond?this.black+=this.plus:this.black=this.originalSecond)}startCountDown(){setInterval(()=>{wTimer.textContent=toMin(this.white),bTimer.textContent=toMin(this.black),wTimer.style.color=this.white/60<=1?"red":"white",bTimer.style.color=this.black/60<=1?"red":"white"},200)}clear(){clearInterval(this.wTimer),clearInterval(this.bTimer)}}function toMin(t){var i=t%60;return Math.floor(t/60)+":"+(i<10?"0"+i:i)}
var Piece,Side,Mode;function byString(e){return Object.values(e).join("")}!function(e){e[e.King=0]="King",e[e.Queen=1]="Queen",e[e.Bishop=2]="Bishop",e[e.Night=3]="Night",e[e.Rook=4]="Rook",e[e.NighQueen=5]="NighQueen",e[e.Pawn=6]="Pawn",e[e.null=-1]="null"}(Piece=Piece||{}),function(e){e[e.White=0]="White",e[e.Black=1]="Black",e[e.null=-1]="null"}(Side=Side||{}),function(e){e[e.classic=0]="classic",e[e.customizable=1]="customizable",e[e.tenXten=2]="tenXten",e[e.null=-1]="null"}(Mode=Mode||{});
async function urlAccess(s){s=checkURL(s);if(s!==Mode.null)return body?.classList.add("possibleURL"),x?.classList.add("hideEle"),s;body?.classList.add("impossibleURL"),o?.classList.add("hideEle")}
function checkURL(e){e=new URL(e).searchParams.get("mode");return"classic"===e?Mode.classic:"customizable"===e?Mode.customizable:"tenXten"===e?Mode.tenXten:Mode.null}
function waitUntil(e){return new Promise(n=>{const t=setInterval(()=>{e()&&(n(null),clearInterval(t))},100)})}
function showBoardTable(o,f){var r,e,l=[];for(let r=0;r<f;r++){l.push([]);for(let o=0;o<f;o++)l[r].push("논")}for(r of o)l[r.vert-1][r.hori-1]=r;for(e of l)console.log(e)}
let BOARDSIZE=8,MODE,checkedOnce=!1,timeOver=!1;function getParam(e){return new URL(window.location.href).searchParams.get(e)}async function playGame(e=[]){const r=new Game({boardsize:BOARDSIZE,customBoard:e});let o=new Timer({second:0,plus:0});getParam("basicTime")&&getParam("addTime")?o=new Timer({second:parseInt(getParam("basicTime")),plus:parseInt(getParam("addTime"))}):window.location.href="./index.html?mode=404";var t=new Notation,s=new Sound;r.showPieces([]),o.start(r.turn),o.startCountDown();const a=setInterval(()=>{o.white<=0&&(o.clear(),shower.innerHTML="시간 초과에 의한<br>흑돌의 승!!",shower.style.color="red",shower.style.display="flex",r.turn===Side.White&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),timeOver=!0,clearInterval(a)),o.black<=0&&(o.clear(),shower.innerHTML="시간 초과에 의한<br>백돌의 승!!",shower.style.color="red",shower.style.display="flex",r.turn===Side.White&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),timeOver=!0,clearInterval(a))},200);for(;;){checkedOnce||r.ifMySideChecked(r.turn)&&(r.showCheckMSG(),s.check.play(),checkedOnce=!0),r.showPresentTurn();var{chosenLocation:i,choosingAction:l}=await r.willMoveListener(r.turn);if(timeOver)break;if(l)r.showWillMoveLocatoin(i);else{if(await r.moveTo(r.presentLocation,i,{show:!0,notation:t}),s.pieceSet.play(),r.init(),r.changeTurn(o),r.twoTimesRightBeforeFalse(),checkedOnce=!1,r.board.filter(e=>e.side===r.turn).map(e=>r.movableLocationsOf(r.getIndexWhoseLocationIs(e.location),!0).length).every(e=>0===e)){o.clear(),eatenPieces(r.eatens),r.ifMySideChecked(r.turn)?(s.checkmate.play(),r.turn?shower.innerHTML="체크 메이트!!<br>백돌 승!":shower.innerHTML="체크 메이트!!<br>흑돌 승!",shower.style.color="red",shower.style.display="flex",r.turn===Side.White&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)")):(s.stalemate.play(),shower.innerHTML="스테일 메이트에<br>의한 무승부!!",shower.style.color="black",shower.style.display="flex");break}if(50<=r.moves){o.clear(),s.fiftyMoves.play(),shower.innerHTML="50수 룰에<br>의한 무승부!!",shower.style.color="black",shower.style.display="flex";break}if(r.impossibilityOfCheckMate()){o.clear(),s.impossibilityOfCheckmate.play(),shower.innerHTML="체크메이트 불가에<br>의한 무승부!!",shower.style.color="black",shower.style.display="flex";break}}if(r.trifoldRep(t)){o.clear(),s.trifoldRepitition.play(),shower.innerHTML="3회 동형 반복에<br>의한 무승부!!",shower.style.color="black",shower.style.display="flex";break}r.showPieces(),eatenPieces(r.eatens)}r.showPieces()}urlAccess(window.location.href).then(async e=>{let r=[];if(e===Mode.tenXten?(BOARDSIZE=10,promotionGrid.style.gridTemplateColumns="repeat(5, 1fr)"):special.remove(),e===Mode.customizable){for(var o of gameInfos)o.style.display="none";createBoard(8),r=await setCustomizableChess(),board.innerHTML="";for(var t of gameInfos)t.style.display="block"}for(var s of customs)s.style.display="none";MODE=e,playGame(r),applyFullscreen()});