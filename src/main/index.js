function classic(){var w=[p("w","k",8,5),p("w","q",8,4),p("w","b",8,3),p("w","b",8,6),p("w","n",8,2),p("w","n",8,7),p("w","r",8,1),p("w","r",8,8),p("b","k",1,5),p("b","q",1,4),p("b","b",1,3),p("b","b",1,6),p("b","n",1,2),p("b","n",1,7),p("b","r",1,1),p("b","r",1,8)];for(let b=1;b<=8;b++)w.push(p("w","p",7,b)),w.push(p("b","p",2,b));return w}function tenXten(){var w=[p("w","k",10,6),p("w","q",10,4),p("w","q",10,7),p("w","b",10,3),p("w","b",10,8),p("w","n",10,2),p("w","n",10,9),p("w","r",10,1),p("w","r",10,10),p("w","x",10,5),p("b","k",1,6),p("b","q",1,4),p("b","q",1,7),p("b","b",1,3),p("b","b",1,8),p("b","n",1,2),p("b","n",1,9),p("b","r",1,1),p("b","r",1,10),p("b","x",1,5)];for(let b=1;b<=10;b++)w.push(p("w","p",9,b)),w.push(p("b","p",2,b));return w}
function createBoard(t){const e=document.querySelector("table"),a=Array(t).fill(1).map((t,e)=>t+e);a.forEach(c=>{const d=document.createElement("tr");e.append(d),a.forEach(t=>{var e=document.createElement("td"),t=(e.setAttribute("id",c.toString()+t.toString()),e.classList.add((c+t)%2?"blackBoard":"whiteBoard"),document.createElement("div")),a=(t.setAttribute("class","text"),document.createElement("div"));a.classList.add("touch","hideEle"),a.textContent="O",d.append(e),e.append(t,a)})})}
const body=document.querySelector("body"),o=document.querySelector("#o"),x=document.querySelector("#x"),whiteSide=document.querySelector("#whiteSide"),blackSide=document.querySelector("#blackSide"),blackEaten=document.querySelector("#whiteSide .eaten"),whiteEaten=document.querySelector("#blackSide .eaten"),shower=document.querySelector("#shower"),wTimer=document.querySelector("#whiteSide .timer"),bTimer=document.querySelector("#blackSide .timer"),promotionGrid=document.querySelector("#promotionGrid"),special=document.querySelector("#special");body,o,x,whiteSide,blackSide,whiteEaten,blackEaten,shower,wTimer,bTimer,promotionGrid,special;
function eatenPieces(t){whiteEaten.textContent="먹은거: "+(t.white.length?t.white.sort((t,e)=>t-e).map(t=>-2===t?"백마탄 여왕님":-1===t?"흑마탄 여왕님":["왕","여왕","비숍","말","룩","폰"][t]).join(", "):"없음"),blackEaten.textContent="먹은거: "+(t.black.length?t.black.sort((t,e)=>t-e).map(t=>-2===t?"백마탄 여왕님":-1===t?"흑마탄 여왕님":["왕","여왕","비숍","말","룩","폰"][t]).join(", "):"없음")}
function applyFullscreen(){var e=document.querySelector("#full");const l=document.querySelector("#fullscreen");null!=e&&e.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen&&(null!==l&&void 0!==l&&l.setAttribute("src","../imgs/fullscreen.png"),document.exitFullscreen()):(null!==l&&void 0!==l&&l.setAttribute("src","../imgs/exit-fullscreen.png"),document.documentElement.requestFullscreen())})}
class Game{constructor(e){this.bs=e,this.board=[],this.boardsize=8,this.mode=Mode.null,this.movableLocations=[],this.presentLocation={vert:-1,hori:-1},this.turn=Side.White,this.eatens={white:[],black:[]},this.showdelay=2e3,this.board=(10===e?tenXten:classic)(),this.boardsize=e,createBoard(e)}showPieces(e=[]){showPiecesFN(this.board,this.bs,e)}async willMoveListener(i){let t={vert:-1,hori:-1},o=!1;function e(e){return()=>{t=e}}function s(e){return()=>{t=e,o=!0}}this.board.forEach(e=>{var t;e.side===i&&(null!=(t=document.getElementById(byString(e.location)))&&t.classList.add(["choosableWhite","choosableBlack"][Array.from(t.id).map(e=>parseInt(e)).reduce((e,t)=>e+t,0)%2]),null!=t)&&t.addEventListener("click",s(e.location))});for(var a of this.movableLocations){var r=document.getElementById(byString(a));null!=r&&r.classList.add(["choosableWhite","choosableBlack"][Array.from(r.id).map(e=>parseInt(e)).reduce((e,t)=>e+t,0)%2]),null!=r&&r.addEventListener("click",e(a))}await waitUntil(()=>-1!==t.hori),this.board.forEach(e=>{var t=document.getElementById(byString(e.location));null!=t&&t.classList.remove("choosableBlack","choosableWhite"),null!=t&&t.removeEventListener("click",s(e.location))});for(var h of this.movableLocations){var n=document.getElementById(byString(h));null!=n&&n.classList.remove("choosableBlack","choosableWhite"),null!=n&&n.removeEventListener("click",e(h))}return{chosenLocation:t,choosingAction:o}}init(){initBoard(this.boardsize),this.movableLocations=[],this.presentLocation={vert:-1,hori:-1}}showScreen(){this.showPieces(),eatenPieces(this.eatens)}showPresentTurn(){switch(this.turn){case Side.White:null!==whiteSide&&void 0!==whiteSide&&whiteSide.classList.remove("opacityDown"),null!==blackSide&&void 0!==blackSide&&blackSide.classList.add("opacityDown");break;case Side.Black:null!==blackSide&&void 0!==blackSide&&blackSide.classList.remove("opacityDown"),null!==whiteSide&&void 0!==whiteSide&&whiteSide.classList.add("opacityDown")}}movableLocationsOf(e,t){const i=this.board[e];let o=Object.values(ml)[i.piece],s=(o=-1!==o.name.indexOf("Pawn")?i.side===Side.White?ml.wPawn:ml.bPawn:o)(i,this.board,this.bs);if(t){const a=JSON.stringify(this.board);s=o(i,this.board,this.bs).filter(e=>(this.board=JSON.parse(a),this.board=this.board.map(e=>{var t=new PieceStruct(e.side,e.piece,e.location);return t.haveMoved=e.haveMoved,t.twoTimesRightBefore=e.twoTimesRightBefore,t}),this.moveTo(i.location,e,{show:!1,notation:new Notation}),console.log(this.checkcheck()),this.checkcheck()===this.turn||this.checkcheck()===Side.null)),this.board=JSON.parse(a),this.board=this.board.map(e=>{var t=new PieceStruct(e.side,e.piece,e.location);return t.haveMoved=e.haveMoved,t.twoTimesRightBefore=e.twoTimesRightBefore,t})}return null!==s&&void 0!==s?s:[]}showWillMoveLocatoin(e){var e=this.getIndexWhoseLocationIs(e),t=this.board[e];this.movableLocations=this.movableLocationsOf(e,!0),initBoard(this.boardsize),this.presentLocation===t.location?(this.showPieces(),this.presentLocation={vert:-1,hori:-1}):(this.showPieces(this.movableLocations),this.presentLocation=t.location)}showCheckMSG(){shower.innerHTML="체!크!",shower.style.display="flex",this.turn===Side.White&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),setTimeout(()=>{shower.style.display="none",shower.style.transform="translate(-50%, -50%) rotate(0deg)"},this.showdelay)}changeTurn(e){e.stop(this.turn),this.turn=this.turn===Side.White?Side.Black:Side.White,e.start(this.turn)}twoTimesRightBeforeFalse(){for(var e of this.board)e.side===this.turn&&e.piece===Piece.Pawn&&(e.twoTimesRightBefore=!1)}getIndexWhoseLocationIs(i){let o=-1;return this.board.forEach((e,t)=>{byString(e.location)===byString(i)&&(o=t)}),o}checkcheck(){let e=Side.null;var i;for(i of[this.turn,this.turn?Side.White:Side.Black]){var o,s=[];for(o of this.board)o.side===i&&s.push(o);let t=[];s.map(e=>this.movableLocationsOf(this.getIndexWhoseLocationIs(e.location),!1)).forEach(e=>{t=[...t,...e]});var a=this.getKingOfOppo(i);-1!==t.map(e=>byString(e)).indexOf(byString(a.location))&&(e=i?Side.Black:Side.White)}return e}getKingOfOppo(e){for(var t of this.board)if(t.side===(e===Side.White?Side.Black:Side.White)&&t.piece===Piece.King)return t;return new PieceStruct(Side.null,Piece.null,{vert:-1,hori:-1})}async moveTo(t,e,{show:i,notation:o}){var s=this.getIndexWhoseLocationIs(e);const a=this.board[this.getIndexWhoseLocationIs(t)];-1!==s&&this.board[s].side!==this.turn&&(i&&this.eatens[this.turn?"white":"black"].push(this.board[s].piece===Piece.NighQueen?this.board[s].side===Side.White?-2:-1:this.board[s].piece===Piece.Pawn?5:this.board[s].piece),this.board=[...this.board.slice(0,s),...this.board.slice(s+1,this.board.length)]),-1===s&&a.piece===Piece.Pawn&&e.hori-a.hori&&(s=this.getIndexWhoseLocationIs({vert:e.vert-(2*a.side-1),hori:e.hori}),this.board=[...this.board.slice(0,s),...this.board.slice(s+1,this.board.length)],i&&this.eatens[this.turn?"white":"black"].push(),i)&&(shower.innerHTML="앙파상!",shower.style.display="flex",this.turn===Side.Black&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),setTimeout(()=>{shower.style.display="none",shower.style.transform="translate(-50%, -50%) rotate(0deg)"},this.showdelay)),a.piece===Piece.Pawn&&(a.haveMoved||2!==Math.abs(a.location.vert-e.vert)||(a.twoTimesRightBefore=!0),a.haveMoved=!0);let r="킹";if(a.piece===Piece.King&&!1===a.haveMoved&&(e.hori-a.hori==2&&(this.board[this.getIndexWhoseLocationIs({vert:a.vert,hori:this.boardsize})].location={vert:a.vert,hori:a.hori+1}),e.hori-a.hori==-2&&(r="퀸",this.board[this.getIndexWhoseLocationIs({vert:a.vert,hori:1})].location={vert:a.vert,hori:a.hori-1}),2===Math.abs(e.hori-a.hori))&&i&&(shower.innerHTML=r+"사이드<br>캐슬링!",shower.style.display="flex",this.turn===Side.Black&&(shower.style.transform="translate(-50%, -50%) rotate(180deg)"),setTimeout(()=>{shower.style.display="none",shower.style.transform="translate(-50%, -50%) rotate(0deg)"},this.showdelay)),[Piece.King,Piece.Rook].some(e=>a.piece===e)&&(a.haveMoved=!0),i&&o.add({from:[a.location.vert,a.location.hori],to:[e.vert,e.hori]}),(a.location=e).vert===(a.side?this.boardsize:1)&&a.piece===Piece.Pawn&&i){t=await promotion(this.mode);let e=Piece.null;switch(t){case"퀸":e=Piece.Queen;break;case"비숍":e=Piece.Bishop;break;case"나이트":e=Piece.Night;break;case"룩":e=Piece.Rook;break;case"나이트퀸":e=Piece.NighQueen}a.piece=e}}}
function getPieceWhoseLocationIs(e,r,i){const o={vert:e,hori:r};let t=-1;return i.forEach((e,r)=>{byString(e.location)===byString(o)&&(t=r)}),-1===t?new PieceStruct(Side.null,Piece.null,{vert:0,hori:0}):i[t]}function king(r,i,o){var e=[{vert:r.vert+1,hori:r.hori+1},{vert:r.vert+1,hori:r.hori-1},{vert:r.vert-1,hori:r.hori+1},{vert:r.vert-1,hori:r.hori-1},{vert:r.vert+1,hori:r.hori},{vert:r.vert-1,hori:r.hori},{vert:r.vert,hori:r.hori+1},{vert:r.vert,hori:r.hori-1}].filter(e=>Object.values(e).every(e=>1<=e&&e<=o)).filter(e=>{return getPieceWhoseLocationIs(e.vert,e.hori,i).side!==r.side});return!1===r.haveMoved&&(Array(o/2-2).fill(0).map((e,r)=>r+1).every(e=>-1===getPieceWhoseLocationIs(r.vert,r.hori+e,i).piece)&&!1===getPieceWhoseLocationIs(r.vert,o,i).haveMoved&&e.push({vert:r.vert,hori:r.hori+2}),Array(o/2-1).fill(0).map((e,r)=>r+1).every(e=>-1===getPieceWhoseLocationIs(r.vert,r.hori-e,i).piece))&&!1===getPieceWhoseLocationIs(r.vert,1,i).haveMoved&&e.push({vert:r.vert,hori:r.hori-2}),e}function queen(e,r,i){return[...bishop(e,r,i),...rook(e,r,i)]}function getIndexWhoseLocationIs(i,e){let o=-1;return e.forEach((e,r)=>{byString(e.location)===byString(i)&&(o=r)}),o}function bishop(o,t,h){let n=[];function i(e,r){var i;return[e,r].some(e=>e<=0||h<e)||((i=t[getIndexWhoseLocationIs(o.location,t)]).piece!==Piece.null?(i.side===o.side||n.push({vert:e,hori:r}),1):void n.push({vert:e,hori:r}))}for(let[e,r]=[o.vert,o.hori];e++,r++,!i(e,r););for(let[e,r]=[o.vert,o.hori];e++,r--,!i(e,r););for(let[e,r]=[o.vert,o.hori];e--,r++,!i(e,r););for(let[e,r]=[o.vert,o.hori];e--,r--,!i(e,r););return n=n.filter(e=>{return getPieceWhoseLocationIs(e.vert,e.hori,t).side!==o.side})}function night(r,i,o){return[{vert:r.vert+2,hori:r.hori+1},{vert:r.vert+2,hori:r.hori-1},{vert:r.vert-2,hori:r.hori+1},{vert:r.vert-2,hori:r.hori-1},{vert:r.vert+1,hori:r.hori+2},{vert:r.vert-1,hori:r.hori+2},{vert:r.vert+1,hori:r.hori-2},{vert:r.vert-1,hori:r.hori-2}].filter(e=>Object.values(e).every(e=>1<=e&&e<=o)).filter(e=>{return getPieceWhoseLocationIs(e.vert,e.hori,i).side!==r.side})}function rook(o,t,r){const h=[];function i(e,r){var i=getPieceWhoseLocationIs(e,r,t);if(i.side!==Side.null&&i.piece!==Piece.null)return i.side!==o.side&&h.push({vert:e,hori:r}),1;h.push({vert:e,hori:r})}for(let e=o.vert+1;e<=r&&!i(e,o.hori);e++);for(let e=o.vert-1;1<=e&&!i(e,o.hori);e--);for(let e=o.hori+1;e<=r&&!i(o.vert,e);e++);for(let e=o.hori-1;1<=e&&!i(o.vert,e);e--);return h}function wPawn(r,i,e){var o=[],t=r.haveMoved?1:2;for(let e=r.vert-1;1<=e&&e>=r.vert-t;e--){const h=getPieceWhoseLocationIs(e,r.hori,i);if(h.piece!==Piece.null)break;o.push({vert:e,hori:r.hori})}var h=getPieceWhoseLocationIs(r.vert-1,r.hori+1,i),h=(h.side!==r.side&&h.side!==Side.null&&o.push({vert:r.vert-1,hori:r.hori+1}),getPieceWhoseLocationIs(r.vert-1,r.hori-1,i));return h.side!==r.side&&h.side!==Side.null&&o.push({vert:r.vert-1,hori:r.hori-1}),4===r.vert&&8===e&&((h=getPieceWhoseLocationIs(r.vert,r.hori-1,i)).side!==r.side&&h.piece===Piece.Pawn&&h.twoTimesRightBefore&&o.push({vert:r.vert-1,hori:r.hori-1}),(h=getPieceWhoseLocationIs(r.vert,r.hori+1,i)).side!==r.side)&&h.piece===Piece.Pawn&&h.twoTimesRightBefore&&o.push({vert:r.vert-1,hori:r.hori+1}),o}function bPawn(r,i,o){var t=[],h=r.haveMoved?1:2;for(let e=r.vert+1;e<=o&&e<=r.vert+h;e++){const n=getPieceWhoseLocationIs(e,r.hori,i);if(n.piece!==Piece.null)break;t.push({vert:e,hori:r.hori})}var n=getPieceWhoseLocationIs(r.vert+1,r.hori+1,i),n=(n.side!==r.side&&n.side!==Side.null&&t.push({vert:r.vert+1,hori:r.hori+1}),getPieceWhoseLocationIs(r.vert+1,r.hori-1,i));return n.side!==r.side&&n.side!==Side.null&&t.push({vert:r.vert+1,hori:r.hori-1}),5===r.vert&&8===o&&((n=getPieceWhoseLocationIs(r.vert,r.hori-1,i)).side!==r.side&&n.piece===Piece.Pawn&&n.twoTimesRightBefore&&t.push({vert:r.vert+1,hori:r.hori-1}),(n=getPieceWhoseLocationIs(r.vert,r.hori+1,i)).side!==r.side)&&n.piece===Piece.Pawn&&n.twoTimesRightBefore&&t.push({vert:r.vert+1,hori:r.hori+1}),t}function nighQueen(e,r,i){let o=[...bishop(e,r,i),...rook(e,r,i),...night(e,r,i)];return o=o.filter((e,r)=>o.indexOf(e)===r)}const ml={king:king,queen:queen,bishop:bishop,night:night,rook:rook,nighQueen:nighQueen,wPawn:wPawn,bPawn:bPawn};
class Notation{constructor(){this.notation=[]}add({from:o,to:t}){this.notation.push({from:o,to:t})}undo(){this.notation.pop()}exportFile(){}}
class PieceStruct{constructor(e,i,t){this.side=e,this.piece=i,this.location=t,this.haveMoved=null,this.twoTimesRightBefore=null,this.piece===Piece.Pawn&&(this.haveMoved=!1,this.twoTimesRightBefore=!1),[Piece.King,Piece.Rook].some(e=>e===this.piece)&&(this.haveMoved=!1)}get vert(){return this.location.vert}get hori(){return this.location.hori}}
function p(e,r,n,t){return new PieceStruct(parseInt(Object.keys(Side)[Array.from("wb").indexOf(e)]),parseInt(Object.keys(Piece)[Array.from("kqbnrxp").indexOf(r)]),{vert:n,hori:t})}
const promotionWindow=document.querySelector("#promotionWindow"),options=document.querySelectorAll("#promotionGrid div");async function promotion(o){let i="";function t(o){return()=>{i=o,console.log("hello")}}return promotionWindow.style.visibility="visible",o===Mode.tenXten&&(document.querySelector("#promotionGrid #special").style.visibility="visible"),options.forEach(o=>{o.addEventListener("click",t(o.textContent))}),await waitUntil(()=>""!==i),options.forEach(o=>{o.removeEventListener("click",t(o.textContent))}),promotionWindow.style.visibility="hidden",o===Mode.tenXten&&(document.querySelector("#promotionGrid #special").style.visibility="hidden"),i}
function showPiecesFN(e,t,i=[]){var l,o;for(l of e){var n=null==(n=document.getElementById(byString(l.location)))?void 0:n.querySelector(".text");n.classList.remove("whitePiece","blackPiece"),n.classList.remove("whiteNighQueen","blackNighQueen"),n.style.backgroundSize="0 0",n.classList.add(["whitePiece","blackPiece"][l.side]),l.piece===Piece.NighQueen?(l.side===Side.White?n.classList.add("whiteNighQueen"):n.classList.add("blackNighQueen"),n.style.backgroundSize="100% 100%"):(l.piece===Piece.Pawn?n.style.backgroundPosition=`100% ${100*l.side}%`:n.style.backgroundPosition=`${20*l.piece}% ${100*l.side}%`,n.style.backgroundSize="600% 200%")}for(let e=11;e<=10*t+1;e+=10){var s=null==(s=document.getElementById(e.toString()))?void 0:s.querySelector(".text");s.innerHTML||(s.innerHTML="&nbsp;")}for(o of i){var c=null==(c=document.getElementById(byString(o)))?void 0:c.querySelector(".touch");null!=c&&c.classList.remove("hideEle","showEle"),null!=c&&c.classList.add("showEle")}}function initBoard(i){for(let t=1;t<=i;t++)for(let e=1;e<=i;e++){var l=null==(l=document.getElementById(byString({vert:t,hori:e})))?void 0:l.querySelector(".touch");null!=l&&l.classList.remove("hideEle","showEle"),null!=l&&l.classList.add("hideEle"),(null==(l=document.getElementById(byString({vert:t,hori:e})))?void 0:l.querySelector(".text")).style.backgroundSize="0 0"}}
"use strict";class Sound{constructor(){this.pieceSet=new Audio("../sound/pieceSet.mp3")}}
class Timer{constructor({second:t,plus:i}){this.white=this.black=this.originalSecond=t,this.plus=i}start(t){t===Side.White?this.wTimer=setInterval(()=>{this.white--},1e3):this.bTimer=setInterval(()=>{this.black--},1e3)}stop(t){t===Side.White?(clearInterval(this.wTimer),this.white+this.plus<=this.originalSecond?this.white+=this.plus:this.white=this.originalSecond):(clearInterval(this.bTimer),this.black+this.plus<=this.originalSecond?this.black+=this.plus:this.black=this.originalSecond)}startCountDown(){setInterval(()=>{wTimer.textContent=toMin(this.white),bTimer.textContent=toMin(this.black),wTimer.style.color=this.white/60<=1?"red":"white",bTimer.style.color=this.black/60<=1?"red":"white"},200)}}function toMin(t){var i=t%60;return Math.floor(t/60)+":"+(i<10?"0"+i:i)}
var Piece,Side,Mode;function byString(e){return Object.values(e).join("")}!function(e){e[e.King=0]="King",e[e.Queen=1]="Queen",e[e.Bishop=2]="Bishop",e[e.Night=3]="Night",e[e.Rook=4]="Rook",e[e.NighQueen=5]="NighQueen",e[e.Pawn=6]="Pawn",e[e.null=-1]="null"}(Piece=Piece||{}),function(e){e[e.White=0]="White",e[e.Black=1]="Black",e[e.null=-1]="null"}(Side=Side||{}),function(e){e[e.classic=0]="classic",e[e.customizable=1]="customizable",e[e.tenXten=2]="tenXten",e[e.null=-1]="null"}(Mode=Mode||{});
async function urlAccess(d){d=checkURL(d);if(d!==Mode.null)return null!==body&&void 0!==body&&body.classList.add("possibleURL"),null!==x&&void 0!==x&&x.classList.add("hideEle"),d;null!==body&&void 0!==body&&body.classList.add("impossibleURL"),null!==o&&void 0!==o&&o.classList.add("hideEle")}
function checkURL(e){e=new URL(e).searchParams.get("mode");return"classic"===e?Mode.classic:"customizable"!==e&&"tenXten"===e?Mode.tenXten:Mode.null}
function waitUntil(e){return new Promise(n=>{const t=setInterval(()=>{e()&&(n(null),clearInterval(t))},100)})}
function showBoardTable(o,f){var r,e,l=[];for(let r=0;r<f;r++){l.push([]);for(let o=0;o<f;o++)l[r].push("논")}for(r of o)l[r.vert-1][r.hori-1]=r;for(e of l)console.log(e)}
let BOARDSIZE=8,MODE;async function playGame(){var e=new Game(BOARDSIZE),o=new Timer({second:1200,plus:5}),n=new Notation,t=new Sound;for(e.showPieces([]),o.start(e.turn),o.startCountDown();;){e.showPresentTurn();var{chosenLocation:a,choosingAction:i}=await e.willMoveListener(e.turn);i?e.showWillMoveLocatoin(a):(await e.moveTo(e.presentLocation,a,{show:!0,notation:n}),e.checkcheck()!==Side.null&&e.showCheckMSG(),t.pieceSet.play(),e.init(),e.changeTurn(o),e.twoTimesRightBeforeFalse()),e.showPieces(),eatenPieces(e.eatens)}}urlAccess(window.location.href).then(e=>{e===Mode.tenXten?(BOARDSIZE=10,promotionGrid.style.gridTemplateColumns="repeat(5, 1fr)"):special.remove(),MODE=e,playGame(),applyFullscreen()});